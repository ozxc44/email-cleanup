<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>扫描邮箱 - CleanInbox</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .animate-pulse-custom { animation: pulse 2s ease-in-out infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .email-fly {
      position: absolute;
      font-size: 24px;
      opacity: 0;
      animation: flyOut 2s ease-out forwards;
    }
    @keyframes flyOut {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100px); opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="bg-white shadow-sm">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        返回
      </a>
      <span class="font-semibold text-gray-900">扫描邮箱</span>
      <div class="w-12"></div>
    </div>
  </div>

  <!-- Scan Content -->
  <div class="max-w-md mx-auto px-4 py-16 text-center">
    <!-- Icon Animation -->
    <div class="relative w-32 h-32 mx-auto mb-8">
      <div class="absolute inset-0 bg-indigo-100 rounded-full animate-pulse-custom"></div>
      <div class="absolute inset-4 bg-indigo-200 rounded-full animate-pulse-custom" style="animation-delay: 0.5s"></div>
      <div class="absolute inset-8 bg-indigo-600 rounded-full flex items-center justify-center animate-float">
        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
      </div>
      <!-- Flying emails container -->
      <div id="flyingEmails" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
    </div>

    <!-- Status Text -->
    <h2 id="statusText" class="text-2xl font-bold text-gray-900 mb-2">正在扫描你的邮箱...</h2>
    <p id="detailText" class="text-gray-600 mb-8">正在连接...</p>

    <!-- Progress -->
    <div class="bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
      <div id="progressBar" class="bg-indigo-600 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
    </div>
    <p id="progressText" class="text-sm text-gray-500">准备中...</p>

    <!-- Tip -->
    <div id="tipBox" class="mt-8 bg-indigo-50 rounded-xl p-4 text-left">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-sm text-indigo-800">小贴士：我们会找出所有有退订选项的营销邮件</p>
      </div>
    </div>

    <!-- Discovered subscriptions (shown during long scans) -->
    <div id="discoveredList" class="mt-8 text-left hidden">
      <p class="text-sm text-gray-500 mb-3">发现的订阅：</p>
      <ul id="discoveredItems" class="space-y-2 max-h-40 overflow-hidden">
      </ul>
    </div>
  </div>

  <script>
    const statusText = document.getElementById('statusText');
    const detailText = document.getElementById('detailText');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const discoveredList = document.getElementById('discoveredList');
    const discoveredItems = document.getElementById('discoveredItems');
    const flyingEmails = document.getElementById('flyingEmails');

    let discoveredCount = 0;

    // 添加飞出的邮件动画
    function addFlyingEmail() {
      const email = document.createElement('div');
      email.className = 'email-fly';
      email.textContent = '@';
      email.style.top = Math.random() * 80 + 10 + '%';
      email.style.left = '0';
      flyingEmails.appendChild(email);
      setTimeout(() => email.remove(), 2000);
    }

    // 更新进度
    function updateProgress(scanned, total, found) {
      const percent = Math.min(90, Math.floor((scanned / total) * 100));
      progressBar.style.width = percent + '%';
      progressText.textContent = `已扫描 ${scanned} 封邮件，找到 ${found} 个订阅`;

      if (found > discoveredCount) {
        // 显示新发现的订阅
        discoveredCount = found;
        if (found > 3) {
          discoveredList.classList.remove('hidden');
        }
      }
    }

    // 开始扫描
    async function startScan() {
      try {
        // 模拟进度更新
        let progress = { scanned: 0, total: 1000, found: 0 };
        const progressInterval = setInterval(() => {
          progress.scanned += Math.floor(Math.random() * 50) + 20;
          progress.found = Math.floor(progress.scanned / 50);
          updateProgress(progress.scanned, progress.total, progress.found);
          addFlyingEmail();
        }, 500);

        const res = await fetch('/api/scan');
        clearInterval(progressInterval);

        if (!res.ok) {
          throw new Error('扫描失败');
        }

        const data = await res.json();

        // 完成进度条
        progressBar.style.width = '100%';
        progressText.textContent = `扫描完成！找到 ${data.count} 个订阅`;
        detailText.textContent = '正在跳转...';

        setTimeout(() => {
          // 存储订阅数据到 sessionStorage
          sessionStorage.setItem('subscriptions', JSON.stringify(data.subscriptions));
          window.location.href = '/list.html';
        }, 1000);

      } catch (error) {
        console.error('Scan error:', error);
        statusText.textContent = '扫描失败';
        detailText.textContent = error.message;
        progressBar.classList.add('bg-red-500');
      }
    }

    // 立即开始扫描
    startScan();
  </script>
</body>
</html>
